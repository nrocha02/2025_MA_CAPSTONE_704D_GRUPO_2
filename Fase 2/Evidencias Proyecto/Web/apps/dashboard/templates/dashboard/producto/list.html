{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}{{ titulo }} - Cordillera Pets{% endblock %}

{% block show_breadcrumb %}True{% endblock %}

{% block breadcrumb %}
{{ block.super }}
<li class="breadcrumb-item active text-white">{{ titulo }}</li>
{% endblock %}

{% block navbar_extra %}{% endblock %}

{% block main_container_class %}-fluid{% endblock %}

{% block page_title %}{{ titulo }}{% endblock %}

{% block page_description %}Administra el catálogo de productos{% endblock %}

{% block page_actions %}
<a href="{% url 'dashboard:producto_create' %}" class="btn btn-success">
  <i class="fas fa-plus"></i> Nuevo Producto
</a>
{% endblock %}

{% block main_content %}

  <!-- Filtros -->
      <div class="card mb-4">
        <div class="card-body">
          <form method="GET" class="row g-3">
            <div class="col-md-3">
              <label class="form-label">Búsqueda</label>
              <input type="text" class="form-control" name="busqueda"
                     value="{{ filtros.busqueda|default:'' }}"
                     placeholder="Nombre del producto">
            </div>
            <div class="col-md-2">
              <label class="form-label">Categoría</label>
              <select class="form-select" name="categoria">
                <option value="">Todas</option>
                {% for categoria in categorias %}
                  <option value="{{ categoria.categoria_id }}"
                          {% if filtros.categoria == categoria.categoria_id|stringformat:"s" %}selected{% endif %}>
                    {{ categoria.nombre }}
                  </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-2">
              <label class="form-label">Marca</label>
              <select class="form-select" name="marca">
                <option value="">Todas</option>
                {% for marca in marcas %}
                  <option value="{{ marca.marca_id }}"
                          {% if filtros.marca == marca.marca_id|stringformat:"s" %}selected{% endif %}>
                    {{ marca.nombre }}
                  </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-2">
              <label class="form-label">Estado</label>
              <select class="form-select" name="estado">
                <option value="">Todos</option>
                <option value="activo" {% if filtros.estado == 'activo' %}selected{% endif %}>Activo</option>
                <option value="inactivo" {% if filtros.estado == 'inactivo' %}selected{% endif %}>Inactivo</option>
                <option value="agotado" {% if filtros.estado == 'agotado' %}selected{% endif %}>Agotado</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">&nbsp;</label>
              <div class="d-grid gap-2 d-md-flex">
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-search"></i> Filtrar
                </button>
                <a href="{% url 'dashboard:producto_list' %}" class="btn btn-outline-secondary">
                  <i class="fas fa-times"></i> Limpiar
                </a>
              </div>
            </div>
          </form>
        </div>
      </div>

  <!-- Tabla de productos -->
      <div class="card">
        <div class="card-body">
          {% if productos %}
            <div class="table-responsive">
              <table class="table table-hover">
                <thead class="table-dark">
                  <tr>
                    <th>Imagen</th>
                    <th>Nombre</th>
                    <th>SKU</th>
                    <th>Categoría</th>
                    <th>Marca</th>
                    <th>Precio</th>
                    <th>Stock</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  {% for producto in productos %}
                    <tr>
                      <td>
                        {% if producto.imagen_url %}
                          <img src="{% static producto.imagen_url %}" alt="{{ producto.nombre }}"
                               class="img-thumbnail" style="width: 50px; height: 50px; object-fit: cover;">
                        {% else %}
                          <div class="bg-light d-flex align-items-center justify-content-center"
                               style="width: 50px; height: 50px;">
                            <i class="fas fa-image text-muted"></i>
                          </div>
                        {% endif %}
                      </td>
                      <td>
                        <strong>{{ producto.nombre }}</strong>
                        {% if producto.descripcion %}
                          <br><small class="text-muted">{{ producto.descripcion|truncatechars:50 }}</small>
                        {% endif %}
                      </td>
                      <td><code>{{ producto.sku }}</code></td>
                      <td>
                        <span class="badge bg-primary">{{ producto.categoria.nombre }}</span>
                      </td>
                      <td>
                        {% if producto.marca %}
                          {{ producto.marca.nombre }}
                        {% else %}
                          <span class="text-muted">Sin marca</span>
                        {% endif %}
                      </td>
                      <td>
                        <strong class="text-success">${{ producto.precio|floatformat:0 }}</strong>
                      </td>
                      <td>
                        {% if producto.stock > 10 %}
                          <span class="badge bg-success">{{ producto.stock }}</span>
                        {% elif producto.stock > 0 %}
                          <span class="badge bg-warning">{{ producto.stock }}</span>
                        {% else %}
                          <span class="badge bg-danger">{{ producto.stock }}</span>
                        {% endif %}
                      </td>
                      <td>
                        {% if producto.estado_producto == 'activo' %}
                          <span class="badge bg-success">Activo</span>
                        {% elif producto.estado_producto == 'inactivo' %}
                          <span class="badge bg-secondary">Inactivo</span>
                        {% elif producto.estado_producto == 'agotado' %}
                          <span class="badge bg-danger">Agotado</span>
                        {% else %}
                          <span class="badge bg-warning">{{ producto.estado_producto|title }}</span>
                        {% endif %}
                      </td>
                      <td>
                        <div class="btn-group btn-group-sm">
                          <a href="{% url 'producto_detalle' producto.producto_id %}"
                             class="btn btn-outline-info" title="Ver" target="_blank">
                            <i class="fas fa-eye"></i>
                          </a>
                          <a href="{% url 'dashboard:producto_edit' producto.producto_id %}"
                             class="btn btn-outline-primary" title="Editar">
                            <i class="fas fa-edit"></i>
                          </a>
                          <a href="{% url 'dashboard:producto_delete' producto.producto_id %}"
                             class="btn btn-outline-danger" title="Eliminar">
                            <i class="fas fa-trash"></i>
                          </a>
                        </div>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

        <!-- Paginación -->
            {% if productos.has_other_pages %}
              <nav class="mt-3">
                <ul class="pagination justify-content-center">
                  {% if productos.has_previous %}
                    <li class="page-item">
                      <a class="page-link" href="?page={{ productos.previous_page_number }}{% if filtros.busqueda %}&busqueda={{ filtros.busqueda }}{% endif %}{% if filtros.categoria %}&categoria={{ filtros.categoria }}{% endif %}{% if filtros.marca %}&marca={{ filtros.marca }}{% endif %}{% if filtros.estado %}&estado={{ filtros.estado }}{% endif %}">
                        <i class="fas fa-chevron-left"></i> Anterior
                      </a>
                    </li>
                  {% endif %}

                  {% for num in productos.paginator.page_range %}
                    {% if productos.number == num %}
                      <li class="page-item active">
                        <span class="page-link">{{ num }}</span>
                      </li>
                    {% elif num > productos.number|add:'-3' and num < productos.number|add:'3' %}
                      <li class="page-item">
                        <a class="page-link" href="?page={{ num }}{% if filtros.busqueda %}&busqueda={{ filtros.busqueda }}{% endif %}{% if filtros.categoria %}&categoria={{ filtros.categoria }}{% endif %}{% if filtros.marca %}&marca={{ filtros.marca }}{% endif %}{% if filtros.estado %}&estado={{ filtros.estado }}{% endif %}">{{ num }}</a>
                      </li>
                    {% endif %}
                  {% endfor %}

                  {% if productos.has_next %}
                    <li class="page-item">
                      <a class="page-link" href="?page={{ productos.next_page_number }}{% if filtros.busqueda %}&busqueda={{ filtros.busqueda }}{% endif %}{% if filtros.categoria %}&categoria={{ filtros.categoria }}{% endif %}{% if filtros.marca %}&marca={{ filtros.marca }}{% endif %}{% if filtros.estado %}&estado={{ filtros.estado }}{% endif %}">
                        Siguiente <i class="fas fa-chevron-right"></i>
                      </a>
                    </li>
                  {% endif %}
                </ul>
              </nav>
            {% endif %}

          {% else %}
            <div class="text-center py-5">
              <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
              <h5 class="text-muted">No hay productos registrados</h5>
              <p class="text-muted">Comienza creando tu primer producto</p>
              <a href="{% url 'dashboard:producto_create' %}" class="btn btn-success">
                <i class="fas fa-plus"></i> Crear Primer Producto
              </a>
            </div>
          {% endif %}
        </div>
      </div>

  <!-- Información adicional -->
      <div class="row mt-4">
        <div class="col-md-6">
          <div class="card">
            <div class="card-body">
              <h6 class="card-title">Estadísticas</h6>
              <ul class="list-unstyled mb-0">
                <li><strong>Total de productos:</strong> {{ productos.paginator.count|default:0 }}</li>
                <li><strong>En esta página:</strong> {{ productos.object_list|length }}</li>
                {% if filtros.busqueda or filtros.categoria or filtros.marca or filtros.estado %}
                  <li><strong>Filtros aplicados:</strong> Sí</li>
                {% endif %}
              </ul>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card">
            <div class="card-body">
              <h6 class="card-title">Acciones rápidas</h6>
              <div class="d-grid gap-2">
                <a href="{% url 'dashboard:admin_dashboard' %}" class="btn btn-outline-secondary btn-sm">
                  <i class="fas fa-arrow-left"></i> Volver al Dashboard
                </a>
                <a href="{% url 'dashboard:categoria_list' %}" class="btn btn-outline-success btn-sm">
                  <i class="fas fa-sitemap"></i> Ver Categorías
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
{% endblock %}