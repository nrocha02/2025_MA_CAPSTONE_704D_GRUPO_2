{% extends 'dashboard/base_dashboard.html' %}
{% load django_bootstrap5 %}
{% load image_tags %}

{% block title %}{{ titulo }} - Cordillera Pets{% endblock %}

{% block show_breadcrumb %}True{% endblock %}

{% block breadcrumb %}
  {{ block.super }}
  <li class="breadcrumb-item"><a href="{% url 'dashboard:producto_list' %}" class="text-white-50">Productos</a></li>
  <li class="breadcrumb-item active text-white">{{ titulo }}</li>
{% endblock %}

{% block navbar_extra %}{% endblock %}

{% block page_title %}{{ titulo }}{% endblock %}

{% block page_description %}
  {% if producto %}
    Modifica los datos del producto
  {% else %}
    Completa los datos para crear un nuevo producto
  {% endif %}
{% endblock %}

{% block page_actions %}
  <a href="{% url 'dashboard:producto_list' %}" class="btn btn-secondary">
    <i class="fas fa-arrow-left"></i> Volver a Lista
  </a>
{% endblock %}

{% block main_content %}

  <div class="row">
    <!-- Formulario -->
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-{% if producto %}edit{% else %}plus{% endif %}"></i>
            Datos del Producto
          </h5>
        </div>
        <div class="card-body">
          <form method="post" enctype="multipart/form-data">
            {% csrf_token %}

            <div class="row mb-3">
              <div class="col-md-8">
                <label for="nombre" class="form-label">Nombre del Producto *</label>
                <input type="text"
                       class="form-control"
                       id="nombre"
                       name="nombre"
                       value="{{ producto.nombre|default:'' }}"
                       required
                       maxlength="50">
              </div>
              <div class="col-md-4">
                <label for="sku" class="form-label">SKU *</label>
                <input type="text"
                       class="form-control"
                       id="sku"
                       name="sku"
                       value="{{ producto.sku|default:'' }}"
                       required
                       maxlength="100">
                <div class="form-text">Código único del producto</div>
              </div>
            </div>

            <div class="mb-3">
              <label for="descripcion" class="form-label">Descripción</label>
              <textarea class="form-control"
                        id="descripcion"
                        name="descripcion"
                        rows="4"
                        placeholder="Descripción detallada del producto">{{ producto.descripcion|default:'' }}</textarea>
            </div>

            <div class="row mb-3">
              <div class="col-md-6">
                <label for="categoria" class="form-label">Categoría *</label>
                <select class="form-select" id="categoria" name="categoria" required>
                  <option value="">Seleccionar categoría</option>
                  {% for categoria in categorias %}
                    <option value="{{ categoria.categoria_id }}"
                            {% if producto.categoria and producto.categoria.categoria_id == categoria.categoria_id %}selected{% endif %}>
                      {% if categoria.nivel == 2 %}→ {% endif %}{{ categoria.nombre }}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-6">
                <label for="marca" class="form-label">Marca</label>
                <select class="form-select" id="marca" name="marca">
                  <option value="">Sin marca</option>
                  {% for marca in marcas %}
                    <option value="{{ marca.marca_id }}"
                            {% if producto.marca and producto.marca.marca_id == marca.marca_id %}selected{% endif %}>
                      {{ marca.nombre }}
                    </option>
                  {% endfor %}
                </select>
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-4">
                <label for="precio" class="form-label">Precio *</label>
                <div class="input-group">
                  <span class="input-group-text">$</span>
                  <input type="number"
                         class="form-control"
                         id="precio"
                         name="precio"
                         value="{{ producto.precio|default:'' }}"
                         required
                         min="0">
                </div>
              </div>
              <div class="col-md-4">
                <label for="stock" class="form-label">Stock</label>
                <input type="number"
                       class="form-control"
                       id="stock"
                       name="stock"
                       value="{{ producto.stock|default:'0' }}"
                       min="0">
              </div>
              <div class="col-md-4">
                {% if producto %}
                  <label for="estado_producto" class="form-label">Estado</label>
                  <select class="form-select" id="estado_producto" name="estado_producto">
                    <option value="activo" {% if producto.estado_producto == 'activo' %}selected{% endif %}>Activo</option>
                    <option value="inactivo" {% if producto.estado_producto == 'inactivo' %}selected{% endif %}>Inactivo</option>
                    <option value="agotado" {% if producto.estado_producto == 'agotado' %}selected{% endif %}>Agotado</option>
                  </select>
                {% endif %}
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Imagen del Producto</label>
              {% is_spaces_configured as spaces_configured %}

              {% if spaces_configured %}
                <div class="mb-3">
                  <div class="input-group">
                    <input type="file"
                           class="form-control"
                           id="imagen_file"
                           name="imagen_file"
                           accept="image/jpeg,image/jpg,image/png,image/webp">
                    <button class="btn btn-outline-danger"
                            type="button"
                            id="btn-limpiar-imagen"
                            title="Limpiar imagen seleccionada"
                            style="display: none;">
                      <i class="fas fa-times"></i> Limpiar
                    </button>
                  </div>
                  <div class="form-text">
                    Formatos permitidos: JPG, PNG, WEBP. Tamaño máximo: 5MB<br>
                    <small class="text-muted">
                      El nombre se convierte automáticamente a slug:
                      <strong>"Alimento Royal Canin.jpg"</strong> → <code>alimento-royal-canin.jpg</code>
                    </small>
                  </div>
                </div>

              {% else %}
                <div class="alert alert-warning">
                  <i class="fas fa-exclamation-triangle"></i>
                  <strong>Carga deshabilitada</strong>
                  <p class="mb-0">Para habilitar la carga de imágenes, configura las credenciales de DigitalOcean Spaces en tu archivo <code>.env</code>:</p>
                  <ul class="small mb-0 mt-2">
                    <li><code>DO_SPACES_ACCESS_KEY</code></li>
                    <li><code>DO_SPACES_SECRET_KEY</code></li>
                    <li><code>DO_SPACES_BUCKET</code></li>
                    <li><code>DO_SPACES_REGION</code></li>
                  </ul>
                </div>
              {% endif %}
            </div>

            <!-- Vista previa de imagen -->
            <div class="mb-3" id="preview-container" style="{% if not producto.imagen_url %}display: none;{% endif %}">
              <label class="form-label">Vista previa{% if producto.imagen_url %} actual{% endif %}</label>
              <div class="position-relative d-inline-block">
                <img id="imagen-preview"
                     src="{% if producto.imagen_url %}{% product_image_url producto.imagen_url %}{% endif %}"
                     alt="Vista previa"
                     class="img-thumbnail"
                     style="max-width: 300px; max-height: 300px;">
                {% if producto.imagen_url %}
                  <button type="button"
                          class="btn btn-danger btn-sm position-absolute top-0 end-0 m-2"
                          id="btn-eliminar-imagen"
                          title="Eliminar imagen del producto">
                    <i class="fas fa-trash"></i> Eliminar imagen
                  </button>
                {% endif %}
              </div>
              <input type="hidden" id="eliminar_imagen" name="eliminar_imagen" value="false">
            </div>

            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
              <a href="{% url 'dashboard:producto_list' %}" class="btn btn-secondary">
                <i class="fas fa-times"></i> Cancelar
              </a>
              {% if producto %}
                {% bootstrap_button button_type="submit" content='<i class="fas fa-save"></i> Actualizar Producto' button_class="btn-warning" %}
              {% else %}
                {% bootstrap_button button_type="submit" content='<i class="fas fa-plus"></i> Crear Producto' button_class="btn-success" %}
              {% endif %}
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Información lateral -->
    <div class="col-md-4">
      <div class="card">
        <div class="card-header">
          <h6 class="mb-0">Ayuda</h6>
        </div>
        <div class="card-body">
          <h6>Consejos para productos:</h6>
          <ul class="small">
            <li>Usa nombres descriptivos y claros</li>
            <li>El SKU debe ser único</li>
            <li>Añade descripciones detalladas</li>
            <li>Asigna la categoría correcta</li>
            <li>Las imágenes mejoran las ventas</li>
          </ul>

          <hr>

          <h6>Estados de producto:</h6>
          <ul class="small">
            <li><strong>Activo:</strong> Visible y comprable</li>
            <li><strong>Inactivo:</strong> No visible públicamente</li>
            <li><strong>Agotado:</strong> Sin stock disponible</li>
          </ul>
        </div>
      </div>

      {% if producto %}
        <div class="card mt-3">
          <div class="card-header">
            <h6 class="mb-0">Información del Producto</h6>
          </div>
          <div class="card-body">
            <ul class="list-unstyled small mb-0">
              <li><strong>ID:</strong> {{ producto.producto_id }}</li>
              <li><strong>Fecha creación:</strong> {{ producto.fecha_creation|date:"d/m/Y H:i" }}</li>
              <li><strong>Estado actual:</strong> {{ producto.estado_producto|title }}</li>
            </ul>

            <div class="mt-3">
              <a href="{% url 'producto_detalle' producto.producto_id %}"
                 class="btn btn-outline-info btn-sm" target="_blank">
                <i class="fas fa-eye"></i> Ver en sitio público
              </a>
            </div>
          </div>
        </div>
      {% endif %}
    </div>
{% endblock %}

{% block extra_js %}
  <script>
// Auto-generar SKU basado en el nombre
    document.getElementById('nombre').addEventListener('input', function() {
      if (!document.getElementById('sku').value) {
        const sku = 'SKU-' + this.value
          .toUpperCase()
          .replace(/[^A-Z0-9\s]/g, '')
          .replace(/\s+/g, '-')
          .substring(0, 20);

        document.getElementById('sku').value = sku;
      }
    });

// Vista previa del archivo seleccionado
    const fileInput = document.getElementById('imagen_file');
    const btnLimpiar = document.getElementById('btn-limpiar-imagen');
    const btnEliminarImagen = document.getElementById('btn-eliminar-imagen');
    const inputEliminarImagen = document.getElementById('eliminar_imagen');

    if (fileInput) {
      fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        const preview = document.getElementById('imagen-preview');
        const container = document.getElementById('preview-container');

        if (file) {
          // Validar tamaño (5MB)
          if (file.size > 5 * 1024 * 1024) {
            alert('El archivo es demasiado grande. Tamaño máximo: 5MB');
            fileInput.value = '';
            container.style.display = 'none';
            btnLimpiar.style.display = 'none';
            return;
          }

          // Validar tipo
          if (!file.type.match('image.*')) {
            alert('Por favor selecciona un archivo de imagen');
            fileInput.value = '';
            container.style.display = 'none';
            btnLimpiar.style.display = 'none';
            return;
          }

          // Mostrar vista previa
          const reader = new FileReader();
          reader.onload = function(e) {
            preview.src = e.target.result;
            container.style.display = 'block';
          };
          reader.readAsDataURL(file);

          // Mostrar botón de limpiar, ocultar botón de eliminar
          btnLimpiar.style.display = 'inline-block';
          if (btnEliminarImagen) {
            btnEliminarImagen.style.display = 'none';
          }

          // Resetear flag de eliminación
          if (inputEliminarImagen) {
            inputEliminarImagen.value = 'false';
          }
        } else {
          // Si no hay archivo y no hay imagen previa, ocultar
          {% if not producto.imagen_url %}
            container.style.display = 'none';
          {% endif %}
          btnLimpiar.style.display = 'none';
        }
      });
    }

    // Función para limpiar la imagen seleccionada
    if (btnLimpiar) {
      btnLimpiar.addEventListener('click', function() {
        const preview = document.getElementById('imagen-preview');
        const container = document.getElementById('preview-container');

        // Limpiar el input de archivo
        fileInput.value = '';

        // Ocultar botón de limpiar
        btnLimpiar.style.display = 'none';

        // Si hay imagen previa del producto, restaurarla
        {% if producto.imagen_url %}
          preview.src = "{% product_image_url producto.imagen_url %}";
          container.style.display = 'block';
          if (btnEliminarImagen) {
            btnEliminarImagen.style.display = 'block';
          }
        {% else %}
          container.style.display = 'none';
        {% endif %}

        // Resetear flag de eliminación
        if (inputEliminarImagen) {
          inputEliminarImagen.value = 'false';
        }
      });
    }

    // Función para eliminar la imagen del producto (solo en edición)
    if (btnEliminarImagen) {
      btnEliminarImagen.addEventListener('click', function() {
        const preview = document.getElementById('imagen-preview');
        const container = document.getElementById('preview-container');

        // Marcar para eliminación
        inputEliminarImagen.value = 'true';

        // Ocultar vista previa
        container.style.display = 'none';

        // Limpiar el input por si había seleccionado un archivo nuevo
        fileInput.value = '';
        btnLimpiar.style.display = 'none';

        // Mostrar mensaje de confirmación
        const form = document.querySelector('form');
        let alert = document.getElementById('alert-imagen-eliminada');
        if (!alert) {
          alert = document.createElement('div');
          alert.id = 'alert-imagen-eliminada';
          alert.className = 'alert alert-warning alert-dismissible fade show';
          alert.innerHTML = `
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Imagen marcada para eliminación</strong>
            <p class="mb-0">La imagen se eliminará cuando guardes los cambios.</p>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          `;
          container.parentElement.insertBefore(alert, container);
        }
      });
    }
  </script>
{% endblock %}