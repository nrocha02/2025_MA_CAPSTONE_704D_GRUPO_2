{% extends 'dashboard/base.html' %}
{% load django_bootstrap5 %}
{% load image_tags %}

{% block title %}{{ titulo }} - Cordillera Pets{% endblock %}

{% block show_breadcrumb %}True{% endblock %}

{% block breadcrumb %}
  {{ block.super }}
  <li class="breadcrumb-item"><a href="{% url 'dashboard:producto_list' %}" class="text-white-50">Productos</a></li>
  <li class="breadcrumb-item active text-white">{{ titulo }}</li>
{% endblock %}

{% block navbar_extra %}{% endblock %}

{% block page_title %}{{ titulo }}{% endblock %}

{% block page_description %}
  {% if producto %}
    Modifica los datos del producto
  {% else %}
    Completa los datos para crear un nuevo producto
  {% endif %}
{% endblock %}

{% block page_actions %}
  <a href="{% url 'dashboard:producto_list' %}" class="btn btn-secondary">
    <i class="fas fa-arrow-left"></i> Volver a Lista
  </a>
{% endblock %}

{% block main_content %}

  <div class="row">
    <!-- Formulario -->
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-{% if producto %}edit{% else %}plus{% endif %}"></i>
            Datos del Producto
          </h5>
        </div>
        <div class="card-body">
          <form method="post">
            {% csrf_token %}

            <div class="row mb-3">
              <div class="col-md-8">
                <label for="nombre" class="form-label">Nombre del Producto *</label>
                <input type="text"
                       class="form-control"
                       id="nombre"
                       name="nombre"
                       value="{{ producto.nombre|default:'' }}"
                       required
                       maxlength="50">
              </div>
              <div class="col-md-4">
                <label for="sku" class="form-label">SKU *</label>
                <input type="text"
                       class="form-control"
                       id="sku"
                       name="sku"
                       value="{{ producto.sku|default:'' }}"
                       required
                       maxlength="100">
                <div class="form-text">Código único del producto</div>
              </div>
            </div>

            <div class="mb-3">
              <label for="descripcion" class="form-label">Descripción</label>
              <textarea class="form-control"
                        id="descripcion"
                        name="descripcion"
                        rows="4"
                        placeholder="Descripción detallada del producto">{{ producto.descripcion|default:'' }}</textarea>
            </div>

            <div class="row mb-3">
              <div class="col-md-6">
                <label for="categoria" class="form-label">Categoría *</label>
                <select class="form-select" id="categoria" name="categoria" required>
                  <option value="">Seleccionar categoría</option>
                  {% for categoria in categorias %}
                    <option value="{{ categoria.categoria_id }}"
                            {% if producto.categoria and producto.categoria.categoria_id == categoria.categoria_id %}selected{% endif %}>
                      {% if categoria.nivel == 2 %}→ {% endif %}{{ categoria.nombre }}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-6">
                <label for="marca" class="form-label">Marca</label>
                <select class="form-select" id="marca" name="marca">
                  <option value="">Sin marca</option>
                  {% for marca in marcas %}
                    <option value="{{ marca.marca_id }}"
                            {% if producto.marca and producto.marca.marca_id == marca.marca_id %}selected{% endif %}>
                      {{ marca.nombre }}
                    </option>
                  {% endfor %}
                </select>
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-4">
                <label for="precio" class="form-label">Precio *</label>
                <div class="input-group">
                  <span class="input-group-text">$</span>
                  <input type="number"
                         class="form-control"
                         id="precio"
                         name="precio"
                         value="{{ producto.precio|default:'' }}"
                         required
                         min="0">
                </div>
              </div>
              <div class="col-md-4">
                <label for="stock" class="form-label">Stock</label>
                <input type="number"
                       class="form-control"
                       id="stock"
                       name="stock"
                       value="{{ producto.stock|default:'0' }}"
                       min="0">
              </div>
              <div class="col-md-4">
                {% if producto %}
                  <label for="estado_producto" class="form-label">Estado</label>
                  <select class="form-select" id="estado_producto" name="estado_producto">
                    <option value="activo" {% if producto.estado_producto == 'activo' %}selected{% endif %}>Activo</option>
                    <option value="inactivo" {% if producto.estado_producto == 'inactivo' %}selected{% endif %}>Inactivo</option>
                    <option value="agotado" {% if producto.estado_producto == 'agotado' %}selected{% endif %}>Agotado</option>
                  </select>
                {% endif %}
              </div>
            </div>

            <div class="mb-3">
              <label for="imagen_url" class="form-label">URL de Imagen</label>
              {% is_spaces_configured as spaces_configured %}
              {% if spaces_configured %}
                <div class="alert alert-info alert-sm mb-2">
                  <i class="fas fa-cloud"></i> <strong>DigitalOcean Spaces configurado</strong><br>
                  <small>Base URL: <code>{% spaces_base_url %}</code></small><br>
                  <small>Ingresa solo el nombre del archivo o ruta relativa. Ejemplo: <code>productos/alimento-perro.jpg</code></small>
                </div>
              {% endif %}
              <input type="text"
                     class="form-control"
                     id="imagen_url"
                     name="imagen_url"
                     value="{{ producto.imagen_url|default:'' }}"
                     placeholder="{% if spaces_configured %}productos/mi-producto.jpg{% else %}blog/images/productos/mi-producto.jpg{% endif %}">
              <div class="form-text">
                {% if spaces_configured %}
                  Ruta del archivo en DigitalOcean Spaces. Ejemplo: productos/alimento.jpg o carpeta/subcarpeta/imagen.jpg
                {% else %}
                  Ruta relativa a la carpeta static. Ejemplo: blog/images/productos/alimento.jpg
                {% endif %}
              </div>
            </div>

            <!-- Vista previa de imagen -->
            <div class="mb-3" id="preview-container" style="display: none;">
              <label class="form-label">Vista previa</label>
              <div class="position-relative d-inline-block">
                <img id="imagen-preview" src="" alt="Vista previa" class="img-thumbnail" style="max-width: 300px; max-height: 300px;">
                <div id="preview-loading" class="position-absolute top-50 start-50 translate-middle" style="display: none;">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                  </div>
                </div>
              </div>
              <div id="preview-error" class="alert alert-warning mt-2" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i> No se pudo cargar la vista previa. Verifica que la URL sea correcta.
              </div>
            </div>

            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
              <a href="{% url 'dashboard:producto_list' %}" class="btn btn-secondary">
                <i class="fas fa-times"></i> Cancelar
              </a>
              {% if producto %}
                {% bootstrap_button button_type="submit" content='<i class="fas fa-save"></i> Actualizar Producto' button_class="btn-warning" %}
              {% else %}
                {% bootstrap_button button_type="submit" content='<i class="fas fa-plus"></i> Crear Producto' button_class="btn-success" %}
              {% endif %}
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Información lateral -->
    <div class="col-md-4">
      <div class="card">
        <div class="card-header">
          <h6 class="mb-0">Ayuda</h6>
        </div>
        <div class="card-body">
          <h6>Consejos para productos:</h6>
          <ul class="small">
            <li>Usa nombres descriptivos y claros</li>
            <li>El SKU debe ser único</li>
            <li>Añade descripciones detalladas</li>
            <li>Asigna la categoría correcta</li>
            <li>Las imágenes mejoran las ventas</li>
          </ul>

          <hr>

          <h6>Estados de producto:</h6>
          <ul class="small">
            <li><strong>Activo:</strong> Visible y comprable</li>
            <li><strong>Inactivo:</strong> No visible públicamente</li>
            <li><strong>Agotado:</strong> Sin stock disponible</li>
          </ul>
        </div>
      </div>

      {% if producto %}
        <div class="card mt-3">
          <div class="card-header">
            <h6 class="mb-0">Información del Producto</h6>
          </div>
          <div class="card-body">
            <ul class="list-unstyled small mb-0">
              <li><strong>ID:</strong> {{ producto.producto_id }}</li>
              <li><strong>Fecha creación:</strong> {{ producto.fecha_creation|date:"d/m/Y H:i" }}</li>
              <li><strong>Estado actual:</strong> {{ producto.estado_producto|title }}</li>
            </ul>

            <div class="mt-3">
              <a href="{% url 'producto_detalle' producto.producto_id %}"
                 class="btn btn-outline-info btn-sm" target="_blank">
                <i class="fas fa-eye"></i> Ver en sitio público
              </a>
            </div>
          </div>
        </div>
      {% endif %}

      <div class="card mt-3">
        <div class="card-header">
          <h6 class="mb-0">Gestión de Imágenes</h6>
        </div>
        <div class="card-body">
          {% is_spaces_configured as spaces_configured %}
          {% if spaces_configured %}
            <div class="alert alert-success alert-sm">
              <i class="fas fa-check-circle"></i> <strong>DigitalOcean Spaces activo</strong>
            </div>
            <p class="small">Las imágenes se cargan desde DigitalOcean Spaces:</p>
            <ul class="small">
              <li>Ingresa solo el nombre del archivo</li>
              <li>Ejemplo: <code>productos/alimento.jpg</code></li>
              <li>La URL completa se construye automáticamente</li>
              <li>Soporta subcarpetas para organización</li>
            </ul>
            <div class="alert alert-info small">
              <strong>URL base:</strong><br>
              <code>{% spaces_base_url %}</code>
            </div>
          {% else %}
            <p class="small">Para las imágenes locales, asegúrate de:</p>
            <ul class="small">
              <li>Subir las imágenes a la carpeta static</li>
              <li>Usar formatos JPG o PNG</li>
              <li>Mantener tamaños razonables (&lt;500KB)</li>
              <li>Usar nombres descriptivos</li>
            </ul>

            <div class="alert alert-info small">
              <strong>Estructura recomendada:</strong><br>
              <code>static/blog/images/productos/[categoria]/[nombre].jpg</code>
            </div>
            
            <div class="alert alert-warning small">
              <i class="fas fa-info-circle"></i> <strong>Tip:</strong> Configura DigitalOcean Spaces en el archivo <code>.env</code> para almacenamiento en la nube.
            </div>
          {% endif %}
        </div>
      </div>
    </div>
{% endblock %}

{% block extra_js %}
  <script>
// Auto-generar SKU basado en el nombre
    document.getElementById('nombre').addEventListener('input', function() {
      if (!document.getElementById('sku').value) {
        const sku = 'SKU-' + this.value
          .toUpperCase()
          .replace(/[^A-Z0-9\s]/g, '')
          .replace(/\s+/g, '-')
          .substring(0, 20);

        document.getElementById('sku').value = sku;
      }
    });

// Vista previa de imagen mejorada para DigitalOcean Spaces
    const imagenUrlInput = document.getElementById('imagen_url');
    const preview = document.getElementById('imagen-preview');
    const container = document.getElementById('preview-container');
    const loadingIndicator = document.getElementById('preview-loading');
    const errorAlert = document.getElementById('preview-error');
    
    // Verificar si está configurado DigitalOcean Spaces
    const spacesConfigured = {% if spaces_configured %}true{% else %}false{% endif %};
    const spacesBaseUrl = '{% spaces_base_url %}';
    
    imagenUrlInput.addEventListener('input', function() {
      const url = this.value.trim();
      
      if (!url) {
        container.style.display = 'none';
        return;
      }
      
      container.style.display = 'block';
      preview.style.display = 'none';
      loadingIndicator.style.display = 'block';
      errorAlert.style.display = 'none';
      
      let fullUrl;
      
      // Construir URL según configuración
      if (spacesConfigured && spacesBaseUrl) {
        // Si es una URL completa (http/https), usarla tal cual
        if (url.startsWith('http://') || url.startsWith('https://')) {
          fullUrl = url;
        } else {
          // Construir URL de DigitalOcean Spaces
          const cleanBaseUrl = spacesBaseUrl.replace(/\/$/, '');
          const cleanUrl = url.replace(/^\//, '');
          fullUrl = `${cleanBaseUrl}/${cleanUrl}`;
        }
      } else {
        // Usar static local
        const cleanUrl = url.startsWith('static/') ? url.substring(7) : url;
        fullUrl = `/static/${cleanUrl}`;
      }
      
      // Intentar cargar la imagen
      const testImage = new Image();
      
      testImage.onload = function() {
        preview.src = fullUrl;
        preview.style.display = 'block';
        loadingIndicator.style.display = 'none';
        errorAlert.style.display = 'none';
      };
      
      testImage.onerror = function() {
        preview.style.display = 'none';
        loadingIndicator.style.display = 'none';
        errorAlert.style.display = 'block';
      };
      
      testImage.src = fullUrl;
    });

// Activar vista previa si ya hay una imagen al cargar la página
    window.addEventListener('load', function() {
      const imagenUrl = imagenUrlInput.value;
      if (imagenUrl) {
        imagenUrlInput.dispatchEvent(new Event('input'));
      }
    });
    
// Ayuda para copiar URL base
    {% if spaces_configured %}
    const spacesUrlAlert = document.querySelector('.alert-info code');
    if (spacesUrlAlert) {
      spacesUrlAlert.style.cursor = 'pointer';
      spacesUrlAlert.title = 'Click para copiar';
      spacesUrlAlert.addEventListener('click', function() {
        navigator.clipboard.writeText('{% spaces_base_url %}').then(() => {
          const originalText = this.textContent;
          this.textContent = '✓ Copiado!';
          setTimeout(() => {
            this.textContent = originalText;
          }, 2000);
        });
      });
    }
    {% endif %}
  </script>
{% endblock %}