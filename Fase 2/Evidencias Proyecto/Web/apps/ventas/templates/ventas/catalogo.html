{% extends "ventas/ventas_base.html" %}
{% load static %}
{% load image_tags %}

{% block title %}Catálogo - Cordillera Pets{% endblock %}

{% block top_bar_message %}Despachos gratis por compras sobre $50.000 dentro de Santiago{% endblock %}

{% block content %}


    <!-- Carrusel de imágenes -->
  <div
    id="carouselExampleControls"
    class="carousel slide"
    data-bs-ride="carousel"
    style="
           width: 100%;
           max-width: 1200px;
           margin: 30px auto;
           border-radius: 15px;
           overflow: hidden;
           box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
          "
  >
    <div class="carousel-inner">
        <!-- Slide 1 -->
      <div class="carousel-item active" data-bs-interval="4000">
        <a href="#">
          <img
            src="{% static 'blog/images/inicio/pitbull.png' %}"
            class="d-block w-100"
            alt="Promoción"
            style="height: 400px; object-fit: cover"
          />
        </a>
      </div>

        <!-- Slide 2 -->
      <div class="carousel-item" data-bs-interval="4000">
        <img
          src="{% static 'blog/images/inicio/michi.png' %}"
          class="d-block w-100"
          alt="Promoción"
          style="height: 400px; object-fit: cover"
        />
      </div>
    </div>

      <!-- Controles -->
    <button
      class="carousel-control-prev"
      type="button"
      data-bs-target="#carouselExampleControls"
      data-bs-slide="prev"
    >
      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Anterior</span>
    </button>
    <button
      class="carousel-control-next"
      type="button"
      data-bs-target="#carouselExampleControls"
      data-bs-slide="next"
    >
      <span class="carousel-control-next-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Siguiente</span>
    </button>
  </div>

<!-- Subcategorías -->
  <div class="container text-center my-5">
    <h4>¡Encuentra lo mejor para tu mascota {{ categoria|lower }}!</h4>
    <div class="row justify-content-center mt-4">
      <div class="col-6 col-md-3 mb-3">
      </div>
    </div>

<!-- Filtros -->
    <div class="container my-4">
      <div class="row">
        <div class="col-md-12">
          <form method="GET" class="d-flex flex-wrap gap-2">
            <select name="categoria" class="form-select" style="width: auto;">
              <option value="">Todas las categorías</option>
              {% for categoria in categorias %}
                <option value="{{ categoria.slug }}"
                        {% if categoria_seleccionada == categoria.slug %}selected{% endif %}>
                  {{ categoria.nombre }}
                </option>
              {% endfor %}
            </select>
            <select name="marca" class="form-select" style="width: auto;">
              <option value="">Todas las marcas</option>
              {% for marca in marcas %}
                <option value="{{ marca.marca_id }}"
                        {% if marca_seleccionada == marca.marca_id|stringformat:"s" %}selected{% endif %}>
                  {{ marca.nombre }}
                </option>
              {% endfor %}
            </select>
            <button type="submit" class="btn btn-primary">Filtrar</button>
            <a href="{% url 'catalogo' %}" class="btn btn-outline-secondary">Limpiar filtros</a>
          </form>
        </div>
      </div>
    </div>

<!--Catalogo con productos dinámicos-->
    <section id="portafolio" class="portfolio section-padding">
      <div class="container">
        <div class="row">
          <div class="col-md-12">
            <div class="section-header text-center pb-5">
              <h4>Productos disponibles ({{ productos|length }})</h4>
            </div>
          </div>
        </div>
        <div class="row">
          {% for producto in productos %}
            <div class="col-12 col-md-6 col-lg-3 mb-4">
              <div class="card text-center bg-white pb-2 h-100">
                <div class="card-body text-dark">
                  <div class="img-area mb-4">
                    {% if producto.imagen_url %}
                      <img src="{% product_image_url producto.imagen_url %}" alt="{{ producto.nombre }}" width="200" height="200" style="object-fit: cover;">
                    {% else %}
                      <div class="d-flex align-items-center justify-content-center bg-light" style="width: 200px; height: 200px; margin: 0 auto;">
                        <span class="text-muted">Sin imagen</span>
                      </div>
                    {% endif %}
                  </div>
                  <h5 class="card-title">{{ producto.nombre }}</h5>
                  <p class="text-muted small">{{ producto.marca.nombre|default:"Sin marca" }}</p>
                  <p class="lead" style="font-size: small;">
                    {{ producto.descripcion|truncatewords:25|default:"Descripción no disponible" }}
                    <br><br>
                    <strong>SKU:</strong> {{ producto.sku }}<br>
                    <strong>Stock:</strong> {{ producto.stock }} unidades<br>
                    <strong>Precio: ${{ producto.precio|floatformat:0 }}</strong>
                  </p>
                  <div class="mt-auto">
                    <a href="{% url 'producto_detalle' producto.producto_id %}" class="btn btn-outline-primary btn-sm me-2">Ver detalle</a>
                    {% if producto.stock > 0 %}
                      <button type="button" class="btn btn-success btn-sm" onclick="agregarAlCarrito({{ producto.producto_id }})">Añadir al Carrito</button>
                    {% else %}
                      <button type="button" class="btn btn-secondary btn-sm" disabled>Sin stock</button>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          {% empty %}
            <div class="col-12 text-center">
              <div class="alert alert-info">
                <h5>No hay productos disponibles</h5>
                <p>No se encontraron productos que coincidan con los filtros seleccionados.</p>
                <a href="{% url 'catalogo' %}" class="btn btn-primary">Ver todos los productos</a>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </section>

<!-- Script para agregar al carrito -->
    <script>
      // Función para obtener el token CSRF
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }

      function agregarAlCarrito(productoId) {
        // Encontrar el botón para mostrar feedback visual
        const boton = document.querySelector(`button[onclick="agregarAlCarrito(${productoId})"]`);
        const textoOriginal = boton.innerHTML;
        
        // Cambiar el botón a estado de carga
        boton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Agregando...';
        boton.disabled = true;

        // Enviar petición AJAX para agregar al carrito
        fetch("{% url 'carrito:agregar_al_carrito' %}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken'),
          },
          body: `action=post&producto_id=${productoId}&cantidad=1`
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Mostrar mensaje de éxito
            boton.innerHTML = '✓ Agregado';
            boton.className = 'btn btn-success btn-sm';
            
            // Actualizar contador del carrito si existe
            const contadorCarrito = document.querySelector('.cart-count, .carrito-count, #cart-count');
            if (contadorCarrito) {
              contadorCarrito.textContent = data.total_productos;
            }
            
            // Mostrar notificación
            mostrarNotificacion(`${data.nombre_producto} agregado al carrito`, 'success');
            
            // Restaurar botón después de 2 segundos
            setTimeout(() => {
              boton.innerHTML = textoOriginal;
              boton.className = 'btn btn-success btn-sm';
              boton.disabled = false;
            }, 2000);
          } else {
            throw new Error('Error al agregar producto');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          boton.innerHTML = textoOriginal;
          boton.disabled = false;
          mostrarNotificacion('Error al agregar producto al carrito', 'error');
        });
      }

      function mostrarNotificacion(mensaje, tipo) {
        // Crear elemento de notificación
        const notificacion = document.createElement('div');
        notificacion.className = `alert alert-${tipo === 'success' ? 'success' : 'danger'} position-fixed`;
        notificacion.style.cssText = `
          top: 20px;
          right: 20px;
          z-index: 9999;
          min-width: 300px;
          animation: slideInRight 0.5s ease-out;
        `;
        notificacion.innerHTML = `
          <strong>${tipo === 'success' ? '✓' : '✗'}</strong> ${mensaje}
          <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
        `;

        // Agregar al DOM
        document.body.appendChild(notificacion);

        // Remover automáticamente después de 3 segundos
        setTimeout(() => {
          if (notificacion.parentElement) {
            notificacion.remove();
          }
        }, 3000);
      }

      // CSS para la animación
      if (!document.querySelector('#notification-styles')) {
        const style = document.createElement('style');
        style.id = 'notification-styles';
        style.textContent = `
          @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
          }
          .spinner-border-sm {
            width: 1rem;
            height: 1rem;
            border-width: 0.15em;
          }
          .spinner-border {
            display: inline-block;
            vertical-align: text-bottom;
            border: 0.25em solid;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border 0.75s linear infinite;
          }
          @keyframes spinner-border {
            to { transform: rotate(360deg); }
          }
        `;
        document.head.appendChild(style);
      }
    </script>



<!-- Productos destacados -->
    {% if productos %}
      <div class="container my-5">
        <h4 class="fw-bold">Productos destacados</h4>
        <div class="row">
          {% for producto in productos|slice:":4" %}
            <div class="col-6 col-md-3 mb-3">
              <div class="card shadow-sm h-100">
                {% if producto.imagen_url %}
                  <img src="{% product_image_url producto.imagen_url %}" class="card-img-top" alt="{{ producto.nombre }}" style="height: 150px; object-fit: cover;">
                {% else %}
                  <div class="card-img-top d-flex align-items-center justify-content-center bg-light" style="height: 150px;">
                    <span class="text-muted">Sin imagen</span>
                  </div>
                {% endif %}
                <div class="card-body text-center">
                  <h6 class="card-title">{{ producto.nombre|truncatechars:30 }}</h6>
                  <p class="text-primary fw-bold">${{ producto.precio|floatformat:0 }}</p>
                  <a href="{% url 'producto_detalle' producto.producto_id %}" class="btn btn-sm btn-outline-primary me-1">Ver</a>
                  {% if producto.stock > 0 %}
                    <button type="button" class="btn btn-sm btn-success" onclick="agregarAlCarrito({{ producto.producto_id }})">Agregar</button>
                  {% else %}
                    <button type="button" class="btn btn-sm btn-secondary" disabled>Sin stock</button>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}

{% endblock %}

{% block extra_js %}
  <script>
    // La función agregarAlCarrito ya está definida arriba
    // Aquí se pueden agregar más funciones específicas del catálogo
    
    document.addEventListener('DOMContentLoaded', function() {
      // Manejar el envío del formulario de filtros
      const form = document.querySelector('form[method="GET"]');
      if (form) {
        form.addEventListener('submit', function(e) {
          // Agregar indicador de carga
          const submitBtn = form.querySelector('button[type="submit"]');
          if (submitBtn) {
            const textoOriginal = submitBtn.innerHTML;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Filtrando...';
            submitBtn.disabled = true;
            
            // En caso de que la página no cambie, restaurar después de un tiempo
            setTimeout(() => {
              if (submitBtn) {
                submitBtn.innerHTML = textoOriginal;
                submitBtn.disabled = false;
              }
            }, 3000);
          }
        });
      }

      // Añadir efectos hover a las cards de productos
      const productCards = document.querySelectorAll('.card');
      productCards.forEach(card => {
        card.addEventListener('mouseenter', function() {
          this.style.transform = 'translateY(-5px)';
          this.style.transition = 'transform 0.3s ease';
        });
        
        card.addEventListener('mouseleave', function() {
          this.style.transform = 'translateY(0)';
        });
      });

      // Mejorar los enlaces de categorías circulares
      const categoryLinks = document.querySelectorAll('a[style*="border-radius:50%"]');
      categoryLinks.forEach(link => {
        link.addEventListener('mouseenter', function() {
          this.style.transform = 'scale(1.05)';
          this.style.transition = 'transform 0.3s ease';
        });
        
        link.addEventListener('mouseleave', function() {
          this.style.transform = 'scale(1)';
        });
      });
    });
  </script>
{% endblock %}
