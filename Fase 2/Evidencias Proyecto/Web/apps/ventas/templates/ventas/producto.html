{% extends "ventas/ventas_base.html" %}
{% load static %}

{% block title %}{{ producto.nombre }} - Cordillera Pets{% endblock %}

{% block content %}

    <!-- Migas de pan -->
  <div class="container mt-3">
    <small>
      <a href="{% url 'index' %}">Inicio</a> /
      <a href="{% url 'catalogo' %}">Catálogo</a> /
      <a
        href="{% url 'catalogo' %}?categoria={{ producto.categoria.categoria_id }}"
      >{{ producto.categoria.nombre }}</a
        >
        / {{ producto.nombre }}
      </small>
    </div>

    <!-- Detalle del producto -->
    <div class="container my-5">
      <div class="row">
        <!-- Imagen del producto -->
        <div class="col-md-6">
          {% if producto.imagen_url %}
            <img
              src="{% static producto.imagen_url %}"
              alt="{{ producto.nombre }}"
              class="img-fluid rounded shadow"
              style="max-height: 500px; width: 100%; object-fit: contain"
            />
          {% else %}
            <div
              class="d-flex align-items-center justify-content-center bg-light rounded"
              style="height: 400px"
            >
              <span class="text-muted fs-4">Sin imagen disponible</span>
            </div>
          {% endif %}
        </div>

        <!-- Información del producto -->
        <div class="col-md-6">
          <h1 class="h2">{{ producto.nombre }}</h1>
          <p class="text-muted mb-3">
            <strong>SKU:</strong> {{ producto.sku }} |
            <strong>Marca:</strong> {{ producto.marca.nombre|default:"Sin marca" }} | <strong>Categoría:</strong> {{ producto.categoria.nombre }}
          </p>

          <div class="mb-4">
            <span class="h3 text-primary fw-bold"
            >${{ producto.precio|floatformat:0 }}</span
              >
            </div>

          <!-- Stock -->
            <div class="mb-3">
              {% if producto.stock > 0 %}
                <span class="badge bg-success fs-6"
                >✓ En stock ({{ producto.stock }} unidades)</span
                  >
              {% else %}
                <span class="badge bg-danger fs-6">✗ Sin stock</span>
              {% endif %}
            </div>

          <!-- Descripción -->
            <div class="mb-4">
              <h5>Descripción</h5>
              <p>
                {{ producto.descripcion|default:"Descripción no disponible"|linebreaks }}
              </p>
            </div>

          <!-- Botones de acción -->
            <div class="d-grid gap-2 d-md-block">
              {% if producto.stock > 0 %}
                <button
                  type="button"
                  class="btn btn-success btn-lg"
                  value="{{ producto.producto_id }}"
                  id="agregar-carrito"
                >
                  🛒 Agregar al carrito
                </button>
              {% else %}
                <button type="button" class="btn btn-secondary btn-lg" disabled>
                  Sin stock disponible
                </button>
              {% endif %}
              <a
                href="{% url 'catalogo' %}"
                class="btn btn-outline-primary btn-lg"
              >Seguir comprando</a>
            </div>
            
            <!-- Área de confirmación -->
            <div id="confirmacion-area" class="mt-3" style="display: none;">
              <div class="alert alert-success d-flex align-items-center" role="alert">
                <i class="fas fa-check-circle me-2 text-success"></i>
                <div>
                  <strong>¡Producto agregado!</strong> 
                  <span id="nombre-producto">{{ producto.nombre }}</span> se ha añadido a tu carrito.
                </div>
              </div>
            </div>
            </div>
          </div>
        </div>

{% endblock %}

{% block extra_js %}
<script>
$(document).on("click", "#agregar-carrito", function (e) {
    e.preventDefault();
    
    const boton = $(this);
    const textoOriginal = boton.html();
    
    boton.html('<span class="spinner-border spinner-border-sm" role="status"></span> Agregando...');
    boton.prop('disabled', true);
    
    $.ajax({
        type: "POST",
        url: "{% url 'carrito:agregar_al_carrito' %}",
        data: {
          producto_id: boton.val(),
          csrfmiddlewaretoken: "{{ csrf_token }}",
          action: "post",
          cantidad: 1
        },
        success: function(json){
          console.log(json);
          
          if (json.success) {
            boton.html('✓ ¡Agregado al carrito!');
            boton.removeClass('btn-success').addClass('btn-success');
            
            $('#confirmacion-area').slideDown(400);
            
            const contadorCarrito = $('.cart-count, .carrito-count, #cart-count');
            if (contadorCarrito.length && json.total_productos) {
              contadorCarrito.text(json.total_productos);
            }
            
            mostrarNotificacion(`${json.nombre_producto || 'Producto'} agregado al carrito exitosamente`, 'success');
            
            $('html, body').animate({
              scrollTop: $('#confirmacion-area').offset().top - 100
            }, 500);
            
            setTimeout(function() {
              boton.html(textoOriginal);
              boton.prop('disabled', false);
            }, 3000);
            
          } else {
            boton.html('Error - Inténtalo de nuevo');
            boton.removeClass('btn-success').addClass('btn-danger');
            mostrarNotificacion('Error al agregar producto al carrito', 'error');
            
            setTimeout(function() {
              boton.html(textoOriginal);
              boton.removeClass('btn-danger').addClass('btn-success');
              boton.prop('disabled', false);
            }, 2000);
          }
        },
        error: function(xhr, errmsg, err){
          console.error('Error:', xhr.responseText);
          
          boton.html('Error - Inténtalo de nuevo');
          boton.removeClass('btn-success').addClass('btn-danger');
          
          mostrarNotificacion('Error de conexión. Inténtalo de nuevo.', 'error');
          
          setTimeout(function() {
            boton.html(textoOriginal);
            boton.removeClass('btn-danger').addClass('btn-success');
            boton.prop('disabled', false);
          }, 2000);
        }
    });
});

function mostrarNotificacion(mensaje, tipo) {
  $('.notificacion-producto').remove();
  
  const notificacion = $(`
    <div class="alert alert-${tipo === 'success' ? 'success' : 'danger'} notificacion-producto position-fixed shadow-lg" 
         style="top: 20px; right: 20px; z-index: 9999; min-width: 350px; animation: slideInRight 0.5s ease-out;">
      <div class="d-flex align-items-center">
        <i class="fas fa-${tipo === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
        <span class="flex-grow-1">${mensaje}</span>
        <button type="button" class="btn-close ms-2" onclick="$(this).closest('.notificacion-producto').remove()"></button>
      </div>
    </div>
  `);
  
  $('body').append(notificacion);
  
  setTimeout(function() {
    notificacion.fadeOut(300, function() {
      $(this).remove();
    });
  }, 4000);
}

if (!$('#notification-styles').length) {
  $('head').append(`
    <style id="notification-styles">
      @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      
      .notificacion-producto {
        border-left: 4px solid;
      }
      
      .alert-success.notificacion-producto {
        border-left-color: #28a745;
      }
      
      .alert-danger.notificacion-producto {
        border-left-color: #dc3545;
      }
    </style>
  `);
}
</script>
{% endblock %}
